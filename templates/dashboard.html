<!DOCTYPE html>
<html>
<head>
  <title>Helm CRM by Redwood Collections</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <link rel="icon" href="/static/favicon.png" type="image/png">
  <style>
    body { margin:0; font-family: Arial; background: #f9f9f9; font-size: 14px; }
    h1, h2, h3, h4, h5, h6 { font-size: 1.4em; margin: 0 0 8px; color: #333; font-weight: bold; }
    .header { height: 80px; background: rgb(91, 103, 112); display: flex; align-items: center; justify-content: space-between; padding: 0 30px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .header img { height: 45px; }
    .header .btn-group { display: flex; gap: 10px; }
    .btn { background: rgb(227,82,5); color: white; border: none; padding: 8px 14px; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 14px; }
    .container { display: flex; height: calc(100vh - 80px); }
    .left { width: 66%; display: flex; flex-direction: column; }
    .right { width: 34%; background: #fff; border-left: 1px solid #ddd; padding: 15px; display: flex; flex-direction: column; }
    .info-box { background: #eef5ff; padding: 18px; border-radius: 8px; margin: 15px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    .info-box p { margin: 4px 0; }
    .section { padding: 15px; border-bottom: 1px solid #eee; display: flex; flex-direction: column; height: 100%; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 4px 8px; text-align: left; border-bottom: 1px solid #eee; font-size: 14px; }
    th { background: #f5f5f5; }
    .note-date, .note-type, .note-user { width: 12%; font-size: 0.85em; color: #555; }
    .note-text { width: 64%; }
    .trans-date, .trans-type, .trans-amount, .trans-user { font-size: 0.9em; }
    .search-form { display: flex; gap: 8px; margin-bottom: 15px; align-items: center; }
    .search-form select, .search-form input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
    .search-form select { width: 150px; }
    .search-form input { flex: 1; }
    .result-row { cursor: pointer; }
    .result-row:hover { background: #f0f0f0; }
    .no-results { color: #777; font-style: italic; padding: 10px 0; }
    .totals { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
    .total-box { background: #eef; padding: 10px; border-radius: 5px; text-align: center; font-weight: bold; }
    .balance { font-weight: bold; font-size: 1.2em; color: #d00; margin-top: 15px; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000; }
    .modal.active { display: flex; }
    .modal-content { background: white; padding: 20px; border-radius: 8px; width: 520px; max-height: 80vh; overflow-y: auto; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
    .close { float: right; font-size: 1.6em; cursor: pointer; color: #999; }
    .close:hover { color: #000; }
    .modal h3 { margin: 0 0 15px; }
    .modal form { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .modal .full { grid-column: 1 / -1; }
    .modal button { grid-column: 1 / -1; margin-top: 10px; }

    /* LINKS = ORANGE */
    .info-box a {
      color: rgb(227,82,5) !important;
      text-decoration: none;
    }
    .info-box a:hover {
      text-decoration: underline;
    }

    /* Horizontal orange edit/delete buttons */
    .action-buttons {
      display: flex;
      gap: 8px;
    }
    .btn-edit {
      background: orange;
      color: white;
      border: none;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    .btn-delete {
      background: #d32f2f;
      color: white;
      border: none;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="header">
    <div style="display:flex; align-items:center; gap:20px;">
      <img src="/static/helm-logo.png" alt="Helm">
      <img src="/static/redwood-logo.png" alt="Redwood Collections">
    </div>
    <div class="btn-group">
      <button class="btn" onclick="openModal('addClientModal')">+ Client</button>
      <button class="btn" onclick="openModal('addCaseModal')">+ Case</button>
      <button class="btn" onclick="openModal('apiModal')">API Keys</button>
      <button class="btn" onclick="location.href='/logout'">Logout ({{ current_user.username }})</button>
    </div>
  </div>

  <div class="container">
    <div class="left">
      {% if not selected_case %}
        <div class="info-box">
          <h2>10 Most Recent Cases</h2>
          <table>
            <tr><th>Client</th><th>Debtor</th><th>Open Date</th><th>Case ID</th></tr>
            {% for case in recent_cases %}
            <tr class="result-row" onclick="location.href='?case_id={{ case.case_id }}'">
              <td>[{{ case.client_id }}] {{ case.business_name }}</td>
              <td>{{ case.debtor }}</td>
              <td>{{ format_date(case.open_date) }}</td>
              <td>{{ case.case_id }}</td>
            </tr>
            {% else %}
            <tr><td colspan="4">No cases yet</td></tr>
            {% endfor %}
          </table>
        </div>
      {% endif %}

      {% if selected_case %}
        <div class="info-box">
          <h2>Case {{ selected_case.id }} — {{ selected_case.debtor_business_name or selected_case.debtor_first ~ ' ' ~ selected_case.debtor_last }}</h2>
          <p><strong>Client:</strong> [{{ case_client.id }}] {{ case_client.business_name }}</p>
          <p><strong>Status:</strong> {{ selected_case.status }} {% if selected_case.substatus %}({{ selected_case.substatus }}){% endif %}</p>
          <p><strong>Next Action:</strong> {{ format_date(selected_case.next_action_date) }}</p>
        </div>

        <div class="section">
          <h3>Notes <button class="btn" onclick="openModal('addNoteModal')" style="float:right; font-size:12px; padding:4px 8px;">+ Note</button></h3>
          <table>
            <tr><th>Date</th><th>Type</th><th>User</th><th>Note</th><th>Actions</th></tr>
            {% for n in notes %}
            <tr>
              <td class="note-date">{{ n.created_at.strftime('%d/%m/%Y %H:%M') if n.created_at else '' }}</td>
              <td class="note-type">{{ n.type }}</td>
              <td class="note-user">{{ n.username }}</td>
              <td class="note-text">{{ n.note }}</td>
              <td>
                <div class="action-buttons">
                  <button class="btn-edit" onclick="editNote({{ n.id }}, '{{ n.type }}', '{{ n.note|e }}')">Edit</button>
                  <button class="btn-delete" onclick="deleteNote({{ n.id }})">Delete</button>
                </div>
              </td>
            </tr>
            {% endfor %}
          </table>
        </div>

        <div class="section">
          <h3>Transactions <button class="btn" onclick="openModal('addTransModal')" style="float:right; font-size:12px; padding:4px 8px;">+ Transaction</button></h3>
          <table>
            <tr><th>Date</th><th>Type</th><th>Amount</th><th>R</th><th>B</th><th>User</th><th>Note</th><th>Actions</th></tr>
            {% for t in transactions %}
            <tr>
              <td>{{ format_date(t.transaction_date) }}</td>
              <td>{{ t.type }}</td>
              <td>£{{ t.amount|floatformat:2 }}</td>
              <td>{% if t.recoverable %}✓{% else %}—{% endif %}</td>
              <td>{% if t.billable %}✓{% else %}—{% endif %}</td>
              <td>{{ t.username }}</td>
              <td>{{ t.note }}</td>
              <td>
                <div class="action-buttons">
                  <button class="btn-edit" onclick="editTransaction({{ t.id }})">Edit</button>
                  <button class="btn-delete" onclick="deleteTransaction({{ t.id }})">Delete</button>
                </div>
              </td>
            </tr>
            {% endfor %}
          </table>

          <div class="totals">
            <div class="total-box">Invoice: £{{ "%.2f"|format(totals.Invoice|float) }}</div>
            <div class="total-box">Payment: £{{ "%.2f"|format(totals.Payment|float) }}</div>
            <div class="total-box">Charge: £{{ "%.2f"|format(totals.Charge|float) }}</div>
            <div class="total-box">Interest: £{{ "%.2f"|format(totals.Interest|float) }}</div>
          </div>
          <div class="balance">Balance: £{{ "%.2f"|format(balance|float) }}</div>
        </div>
      {% endif %}
    </div>

    <div class="right">
      <div class="search-form">
        <input type="text" id="searchInput" placeholder="Search..." onkeyup="doSearch()">
        <select id="searchField">
          <option value="debtor_name">Debtor Name</option>
          <option value="client_name">Client Name</option>
          <option value="email">Email</option>
          <option value="phone">Phone</option>
          <option value="postcode">Postcode</option>
        </select>
      </div>
      <div id="searchResults"></div>
    </div>
  </div>

  <!-- Your existing modals go here — unchanged -->
  <!-- Add Client, Add Case, Add Note, Add Transaction, Edit Note, Edit Transaction, API Keys -->

  <script>
    // Your full existing JavaScript goes here — unchanged
    // doSearch(), openModal(), client search, API keys, edit/delete functions — all stay exactly as you had them
    // Only change: the date line in notes is now safe
  </script>
</body>
</html>
